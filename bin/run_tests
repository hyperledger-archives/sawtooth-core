#!/bin/bash

set -e

top_dir=$(cd $(dirname $(dirname $0)) && pwd)

PATH=$top_dir/bin:$PATH
export PATH

PYTHONPATH=$top_dir/core
export PYTHONPATH
cd core
nose2 -v
cd ..

PYTHONPATH=$top_dir
PYTHONPATH=$PYTHONPATH:$top_dir/signing
PYTHONPATH=$PYTHONPATH:$top_dir/signing/build/lib.linux-x86_64-2.7
export PYTHONPATH
cd signing
nose2 -v
cd ..

PYTHONPATH=$top_dir
PYTHONPATH=$PYTHONPATH:$top_dir/signing
PYTHONPATH=$PYTHONPATH:$top_dir/signing/build/lib.linux-x86_64-2.7
PYTHONPATH=$PYTHONPATH:$top_dir/core
PYTHONPATH=$PYTHONPATH:$top_dir/validator
PYTHONPATH=$PYTHONPATH:$top_dir/validator/build/lib.linux-x86_64-2.7
export PYTHONPATH
cd validator
nose2 -v unit

# Disable nose2-3 within docker container until bugs can be resolved.
if [ "$DOCKER_CONTAINER_ID" = "" ]; then
    nose2-3 -v unit3
fi

export RUN_TEST_SUITES=1
nose2 -v sawtooth_suites.ts_pr_dev_mode.DevModeTestSuite
nose2 -v sawtooth_suites.ts_pr_poet0.Poet0TestSuite
unset RUN_TEST_SUITES
cd ..

PYTHONPATH=$top_dir
PYTHONPATH=$PYTHONPATH:$top_dir/signing
PYTHONPATH=$PYTHONPATH:$top_dir/signing/build/lib.linux-x86_64-2.7
PYTHONPATH=$PYTHONPATH:$top_dir/core
PYTHONPATH=$PYTHONPATH:$top_dir/validator
PYTHONPATH=$PYTHONPATH:$top_dir/validator/build/lib.linux-x86_64-2.7
PYTHONPATH=$PYTHONPATH:$top_dir/extensions/mktplace
export PYTHONPATH
cd extensions/mktplace
nose2 -v unit
export RUN_TEST_SUITES=1
nose2 -v sawtooth_suites.ts_pr_mkt_poet0.Poet0MktTestSuite
unset RUN_TEST_SUITES
cd ../..

PYTHONPATH=$top_dir
PYTHONPATH=$PYTHONPATH:$top_dir/signing
PYTHONPATH=$PYTHONPATH:$top_dir/signing/build/lib.linux-x86_64-2.7
PYTHONPATH=$PYTHONPATH:$top_dir/core
PYTHONPATH=$PYTHONPATH:$top_dir/validator
PYTHONPATH=$PYTHONPATH:$top_dir/validator/build/lib.linux-x86_64-2.7
PYTHONPATH=$PYTHONPATH:$top_dir/extensions/bond
export PYTHONPATH
cd extensions/bond
nose2 -v
cd ../..
